<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CarSense AI - Pro Diagnostic</title>
    <script src="engine.js"></script>
    <style>
        body { background: #0f0f0f; color: #e0e0e0; font-family: sans-serif; text-align: center; padding: 20px; }
        .box { background: #1a1a1a; max-width: 400px; margin: auto; padding: 20px; border-radius: 15px; border: 1px solid #333; }
        .label { font-size: 2em; color: #007bff; font-weight: bold; display: block; margin: 20px 0; }
        #status { font-size: 0.9em; color: #666; }
    </style>
</head>
<body>
    <div class="box">
        <h2>CARSENSE AI</h2>
        <div id="status">Loading Brain...</div>
        <div class="label" id="resLabel">STANDBY</div>
        <button id="startBtn" onclick="startInference()" style="padding:10px 20px; border-radius:8px; cursor:pointer;">START LISTENING</button>
    </div>

    <script>
        let classifier;
        let ws;

        async function initAI() {
            const status = document.getElementById('status');
            
            try {
                // STEP 1: Manually fetch the WASM as binary data 
                // This "steals" the approach from the mobile-client to bypass MIME errors
                status.innerText = "Downloading model binary...";
                const response = await fetch('edge-impulse-standalone.wasm.dat');
                const wasmBuffer = await response.arrayBuffer();

                // STEP 2: Initialize the Edge Impulse library
                // We pass the buffer directly so it doesn't try to fetch it again
                classifier = new EdgeImpulseClassifier();
                
                // We override the internal loader to use our downloaded buffer
                Module['wasmBinary'] = wasmBuffer;
                
                await classifier.init();
                
                status.innerText = "System Ready âœ…";
                status.style.color = "#4caf50";
                connectWS();
            } catch (err) {
                console.error(err);
                status.innerText = "Error: " + err.message;
            }
        }

        function connectWS() {
            ws = new WebSocket("wss://esp32serverproject2.onrender.com/?type=Browser");
            ws.onmessage = (e) => {
                // Here we would feed ESP32 data into classifier.classify()
                console.log("Data from ESP32:", e.data);
            };
        }

        function startInference() {
            if (ws && ws.readyState === 1) ws.send("START");
        }

        // Wait for engine.js to load, then trigger our manual init
        window.onload = initAI;
    </script>
</body>
</html>
