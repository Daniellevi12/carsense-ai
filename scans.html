<!doctype html>
<html lang="he" dir="rtl">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>CarSense — סריקות</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script type="module" src="carsense.js"></script>
</head>

<body class="bg-dark text-white text-center">
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
    <div class="container-fluid">
      <a class="navbar-brand" href="index.html">CarSense</a>

      <button id="loginBtn" class="btn btn-outline-light ms-2" style="margin-right: 20px;">Login</button>
      <button id="logoutBtn" class="btn btn-outline-light ms-2" style="display:none; margin-right: 20px">Logout</button>

      <div class="collapse navbar-collapse">
        <ul class="navbar-nav me-auto">
          <li class="nav-item"><a class="nav-link" href="demo.html">Demo</a></li>
          <li class="nav-item"><a class="nav-link" href="features.html">Features</a></li>
          <li class="nav-item"><a class="nav-link" href="listen.html">Listen</a></li>
          <li class="nav-item"><a class="nav-link" href="scans.html">Scans</a></li>
          <li class="nav-item"><a class="nav-link" href="cars.html">Cars</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container vh-100 d-flex flex-column justify-content-start align-items-center"
    style="background-image: url('https://cdn.motor1.com/images/mgl/0ANkN/s1/lamborghini-revuelto-front-view.jpg'); background-size: cover; background-position: center;">
    <div class="bg-dark bg-opacity-75 p-4 rounded w-100 mt-3">
      <h2 class="mb-4">הרכבים שלי</h2>

      <div id="carsContainer" class="d-flex flex-wrap justify-content-center gap-3">
        <!-- All user cars with photos will appear here -->
      </div>

      <div id="scansList" class="mt-4">
        <!-- Previous scans of selected car will appear here -->
      </div>
    </div>
  </div>

  <script type="module">
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-database.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";

    const db = getDatabase();
    const auth = getAuth();

    const carsContainer = document.getElementById("carsContainer");
    const scansList = document.getElementById("scansList");

    let currentUser = null;

    // Show cars
    function showCars(user) {
      const carsRef = ref(db, `users/${user.uid}/cars`);

      onValue(carsRef, snap => {
        carsContainer.innerHTML = "";
        scansList.innerHTML = "";

        snap.forEach(carSnap => {
          const car = carSnap.val();
          const carId = carSnap.key;

          const div = document.createElement("div");
          div.className = "card bg-dark text-white p-2";
          div.style.cursor = "pointer";
          div.style.width = "200px";

          let imgUrl = car.img || "";
          div.innerHTML = `
        <h5>${car.make} ${car.model} (${car.year})</h5>
        <p>Plate: ${car.plate}</p>
        ${imgUrl ? `<img src="${imgUrl}" style="max-width:180px; display:block; margin:auto;">` : ""}
      `;

          div.addEventListener("click", () => showCarScans(user.uid, carId));
          carsContainer.appendChild(div);

          // Load image asynchronously if missing
          if (!imgUrl && window.getCarImage) {
            window.getCarImage(car.make, car.model, car.year)
              .then(url => {
                const img = document.createElement("img");
                img.src = url;
                img.style.maxWidth = "180px";
                img.style.display = "block";
                img.style.margin = "auto";
                div.appendChild(img);
              })
              .catch(err => console.error("Failed to load car image:", err));
          }
        });
      });
    }

    // Show previous scans for a car
    function showCarScans(uid, carId) {
      scansList.innerHTML = "<h4>סריקות קודמות של הרכב</h4>";

      const scansRef = ref(db, `users/${uid}/cars/${carId}/scans`);
      onValue(scansRef, snap => {
        scansList.innerHTML = "<h4>סריקות קודמות של הרכב</h4>";

        if (!snap.exists()) {
          scansList.innerHTML += "<p>אין סריקות קודמות לרכב זה</p>";
          return;
        }

        snap.forEach(scanSnap => {
          const scan = scanSnap.val();
          const div = document.createElement("div");
          div.className = "alert alert-info mt-2 text-dark";
          div.innerHTML = `
        <strong>תקלה:</strong> ${scan.label || "לא ידוע"}<br>
        <small>${scan.timestamp ? new Date(scan.timestamp + 3 * 60 * 60 * 1000).toLocaleString("he-IL") : ""}</small>
      `;
          scansList.appendChild(div);
        });
      });
    }

    // Auth listener
    onAuthStateChanged(auth, user => {
      if (!user) {
        carsContainer.innerHTML = "<p>נא להתחבר כדי לראות רכבים וסריקות</p>";
        scansList.innerHTML = "";
        return;
      }
      currentUser = user;
      showCars(user);
    });

  </script>



  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>